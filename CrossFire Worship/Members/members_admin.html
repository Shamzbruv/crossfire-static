<!DOCTYPE html>
<html lang="en">
<head>
  <title>Admin - Crossfire Worship Center</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
    :root { --color-primary:#0f2c59; --color-secondary:#f39c12; }
    .font-serif{font-family:'Cormorant Garamond',serif;}
    .font-sans{font-family:'Lato',sans-serif;}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.6rem 1rem;border-radius:9999px;font-weight:700}
    .btn-outline{border:1px solid #d1d5db;color:var(--color-primary);background:#fff}
    .btn-primary{background:var(--color-secondary);color:#fff}
    .nav-link{padding:.5rem .75rem;border-radius:.5rem}
    .nav-link:hover{background:#f3f4f6}
    .card{border-radius:1rem;border:1px solid #e5e7eb;background:#fff}
    .kicker{letter-spacing:.15em;text-transform:uppercase;font-weight:700;font-size:.75rem;color:#6b7280}
  
/* --- Site-wide mobile polish (Members area) --- */
@media (max-width: 640px){
  .mobile-pad { padding-left: 1rem; padding-right: 1rem; }
  .hero-tight { min-height: 60vh; }
  .mobile-leading { line-height: 1.35; }
  .mobile-tap a, .mobile-tap button { min-height: 44px; display:inline-flex; align-items:center; }
  .grid-auto-xs { grid-template-columns: repeat(1, minmax(0,1fr)); }
}
/* Improve sticky headers visibility on scroll */
.sticky\:shadow-when-scrolled{ box-shadow: 0 1px 0 rgba(17,24,39,.06); }
/* Better cards on dense screens */
.card{ border-radius:1rem; border:1px solid #e5e7eb; background:#fff }
.card-sm{ padding: .875rem }
img[loading="lazy"]{ content-visibility:auto }

</style>
</head>
<body class="font-sans text-gray-800 bg-gray-50">
<header class="sticky top-0 z-50 bg-white/95 backdrop-blur border-b">
  <div class="container mx-auto px-4 h-16 flex items-center justify-between">
    <a href="../index.html#home" class="flex items-center gap-3 shrink-0">
      <img src="https://crossfireworshipcenter.org/wp-content/uploads/2023/04/Church-Of-God-Logo-58x63.png" alt="logo" class="h-8 w-auto" loading="lazy">
      <span class="font-extrabold text-[color:var(--color-primary)]">Crossfire Worship Center</span>
    </a>
    <nav class="hidden lg:flex items-center gap-1 text-[color:var(--color-primary)] font-semibold">
      <a href="members_dashboard.html" class="nav-link">Dashboard</a>
      <a href="members_directory.html" class="nav-link">Directory</a>
      <a href="members_resources.html" class="nav-link">Resources</a>
      <a href="members_events.html" class="nav-link">Events</a>
      <a href="members_prayers.html" class="nav-link">Prayers</a>
      <a href="members_forum.html" class="nav-link">Forum</a>
      <a href="members_profile.html" class="nav-link">Profile</a>
      <a href="members_admin.html" class="nav-link font-bold text-[color:var(--color-secondary)]">Admin</a>
    </nav>
    <div class="hidden lg:flex items-center gap-3">
      <span id="whoami" class="hidden md:inline text-xs text-gray-500"></span>
      <button id="btnSignOut" class="btn-outline text-sm">Sign Out</button>
    </div>
  </div>
</header>

<main>
  <section class="bg-gray-50">
    <div class="container mx-auto px-4 py-10 md:py-10 md:py-14">
      <p class="kicker">Members</p>
      <h1 class="text-3xl md:text-4xl font-extrabold text-[color:var(--color-primary)]">Admin Console</h1>
      <p class="muted mt-2 max-w-3xl">Approve new users, manage events and forum posts, and handle resources.</p>
    </div>
  </section>

  <section class="container mx-auto px-4 pb-20 grid gap-8 max-w-6xl">
    <!-- Pending Approvals -->
    <div class="card p-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">Pending Signups</h2>
        <button id="refresh-approvals" class="btn-outline">Refresh</button>
      </div>
      <div id="pending-list" class="divide-y"></div>
    </div>

    <!-- Events Manager -->
    <div class="card p-6">
      <h2 class="text-xl font-semibold mb-3">Events Manager</h2>
      <div class="grid md:grid-cols-4 gap-3">
        <input id="admin-event-name" class="border rounded p-2" placeholder="Event name">
        <input id="admin-event-date" type="date" class="border rounded p-2">
        <input id="admin-event-location" class="border rounded p-2" placeholder="Location (optional)">
        <button id="admin-add-event" class="btn-primary">Add Event</button>
      </div>
      <ul id="admin-events" class="mt-4 divide-y"></ul>
    </div>

    <!-- Forum Manager -->
    <div class="card p-6">
      <h2 class="text-xl font-semibold mb-3">Forum Manager</h2>
      <div class="grid md:grid-cols-3 gap-3">
        <input id="admin-forum-title" class="border rounded p-2" placeholder="Title">
        <input id="admin-forum-author" class="border rounded p-2" placeholder="Author (optional)">
        <button id="admin-add-forum" class="btn-primary">Post</button>
      </div>
      <textarea id="admin-forum-text" class="border rounded p-2 w-full mt-3" placeholder="Message"></textarea>
      <ul id="admin-forum" class="mt-4 divide-y"></ul>
    </div>

    <!-- Resources Manager -->
    <div class="card p-6">
      <h2 class="text-xl font-semibold mb-3">Resources Manager</h2>
      <div class="grid md:grid-cols-3 gap-3">
        <input id="admin-resource-name" class="border rounded p-2" placeholder="Resource Name">
        <input id="admin-resource-file" type="file" class="border rounded p-2">
        <button id="admin-upload-resource" class="btn-primary">Upload</button>
      <input id="admin-resource-url" type="url" class="border rounded p-2" placeholder="OR paste public URL (Drive/Dropbox/etc.)">
      </div>
      <ul id="admin-resources" class="mt-4 divide-y"></ul>
    </div>
  </section>
</main>

<script type="module">
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, collection, query, where, getDocs, doc, getDoc, updateDoc, setDoc, addDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
  import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

  const auth = getAuth();
  const db = getFirestore();
  const storage = getStorage();
  const ADMIN_EMAILS = ['your-church@gmail.com']; // TODO: put your official Gmail here

  onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = 'members.html';
    const who = document.getElementById('whoami');
    if (who) who.textContent = user.email;
    const snap = await getDoc(doc(db,'users', user.uid));
    const data = snap.exists() ? snap.data() : {};
    const isAdmin = (data.role === 'admin') || ADMIN_EMAILS.includes((user.email||'').toLowerCase());
    if (!isAdmin) return window.location.href = 'members_dashboard.html';

    document.getElementById('btnSignOut')?.addEventListener('click', async () => { await signOut(auth); window.location.href = 'members.html'; });

    // Approvals
    async function loadApprovals(){
      const q = query(collection(db,'users'), where('approved','==', false));
      const list = document.getElementById('pending-list');
      list.innerHTML = '';
      const snap = await getDocs(q);
      if (snap.empty){ list.innerHTML = '<div class="text-gray-500 text-sm">No pending signups.</div>'; return; }
      snap.forEach(d => {
        const u = d.data();
        const row = document.createElement('div');
        row.className = 'py-3 flex items-center justify-between';
        row.innerHTML = \`
          <div>
            <div class="font-medium">\${u.name || '(No name)'} <span class="text-xs text-gray-500">(\${u.email || ''})</span></div>
            <div class="text-xs text-gray-500">uid: \${d.id}</div>
          </div>
          <div class="flex gap-2">
            <button class="px-3 py-1.5 rounded bg-green-600 text-white" data-approve>Approve</button>
            <button class="px-3 py-1.5 rounded bg-red-600 text-white" data-deny>Deny</button>
          </div>\`;
        row.querySelector('[data-approve]').onclick = async () => {
          await updateDoc(doc(db,'users', d.id), { approved: true, approvedAt: serverTimestamp() });
          loadApprovals();
        };
        row.querySelector('[data-deny]').onclick = async () => {
          await updateDoc(doc(db,'users', d.id), { blocked: true, approved: false, deniedAt: serverTimestamp() });
          loadApprovals();
        };
        document.getElementById('pending-list').appendChild(row);
      });
    }
    document.getElementById('refresh-approvals')?.addEventListener('click', loadApprovals);
    await loadApprovals();

    // Events manager
    async function loadEvents(){
      const ul = document.getElementById('admin-events'); ul.innerHTML='';
      const snap = await getDocs(collection(db,'events'));
      snap.forEach(s => {
        const e = s.data();
        const li = document.createElement('li');
        li.className = 'py-2 flex items-center justify-between';
        li.innerHTML = \`<div>\${e.name} <span class="text-gray-500">(\${e.date || ''})</span> <span class="text-xs">\${e.location||''}</span></div>
          <div class="flex gap-2">
            <button class="px-2 py-1 rounded bg-red-600 text-white" data-del>Delete</button>
          </div>\`;
        li.querySelector('[data-del]').onclick = async () => { await deleteDoc(doc(db,'events', s.id)); loadEvents(); };
        ul.appendChild(li);
      });
    }
    document.getElementById('admin-add-event')?.addEventListener('click', async () => {
      const name = document.getElementById('admin-event-name').value.trim();
      const date = document.getElementById('admin-event-date').value;
      const location = document.getElementById('admin-event-location').value.trim();
      if (!name) return alert('Event name required');
      await addDoc(collection(db,'events'), { name, date, location, attendees: [], createdAt: serverTimestamp() });
      await loadEvents();
    });
    await loadEvents();

    // Forum manager
    async function loadForum(){
      const ul = document.getElementById('admin-forum'); ul.innerHTML='';
      const snap = await getDocs(collection(db,'forum'));
      snap.forEach(s => {
        const f = s.data();
        const li = document.createElement('li');
        li.className = 'py-2 flex items-center justify-between';
        li.innerHTML = \`<div><strong>\${f.title}</strong> by \${f.userName||''}</div>
          <button class="px-2 py-1 rounded bg-red-600 text-white" data-del>Delete</button>\`;
        li.querySelector('[data-del]').onclick = async () => { await deleteDoc(doc(db,'forum', s.id)); loadForum(); };
        ul.appendChild(li);
      });
    }
    document.getElementById('admin-add-forum')?.addEventListener('click', async () => {
      const title = document.getElementById('admin-forum-title').value.trim();
      const text = document.getElementById('admin-forum-text').value.trim();
      const author = document.getElementById('admin-forum-author').value.trim();
      if (!title || !text) return alert('Missing title or message');
      await addDoc(collection(db,'forum'), { title, text, userName: author || (data.name || 'Admin'), timestamp: serverTimestamp() });
      await loadForum();
    });
    await loadForum();

    // Resources manager
    async function loadResources(){
      const ul = document.getElementById('admin-resources'); ul.innerHTML='';
      const snap = await getDocs(collection(db,'resources'));
      snap.forEach(async s => {
        const r = s.data();
        const li = document.createElement('li');
        li.className = 'py-2 flex items-center justify-between';
        li.innerHTML = \`<a href="\${r.url}" class="text-blue-600 hover:underline">\${r.name}</a>
          <div class="flex gap-2"><button class="px-2 py-1 rounded bg-red-600 text-white" data-del>Delete</button></div>\`;
        li.querySelector('[data-del]').onclick = async () => {
          try {
            const url = new URL(r.url);
            const pathIndex = url.pathname.indexOf('/o/');
            if (pathIndex !== -1) {
              const encodedPath = url.pathname.split('/o/')[1];
              const filePath = decodeURIComponent(encodedPath.split('?')[0]);
              await deleteObject(storageRef(getStorage(), filePath));
            }
          } catch {}
          await deleteDoc(doc(db,'resources', s.id));
          await loadResources();
        };
        ul.appendChild(li);
      });
    }
    document.getElementById('admin-upload-resource')?.addEventListener('click', async () => {
      const name = document.getElementById('admin-resource-name').value.trim();
      const file = document.getElementById('admin-resource-file').files[0];
      if (!name || !file) return alert('Missing name or file');
      const ref = storageRef(getStorage(), 'resources/' + file.name);
      await uploadBytes(ref, file);
      const url = await getDownloadURL(ref);
      await addDoc(collection(db,'resources'), { name, url, createdAt: serverTimestamp() });
      await loadResources();
    });
    await loadResources();
  });
</script>
</body></html>
